name: Scheduled Load Test and Report

on:
  schedule:
    - cron: '*/11 * * * *'
  workflow_dispatch:

jobs:
  load-test-and-report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-json-report locust requests

    - name: Run Pytest
      env:
        PYTHONPATH: .
        DATABASE_URL: "sqlite:///:memory:"
        FLASK_ENV: testing
      run: |
        pytest --json-report --json-report-file=result.json

    - name: Load Test & Report
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        INTERNAL_SYNC_KEY: ${{ secrets.INTERNAL_SYNC_KEY }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SERVER_URL: ${{ secrets.SERVER_URL }}
        TARGET_HOST: ${{ secrets.TARGET_HOST }}
        LOCUST_TEST_USER_ID: ${{ secrets.LOCUST_TEST_USER_ID }}
        FLASK_ENV: production
        PORT: 5000
        PYTHONPATH: .
      run: |
        python save_report.py > debug.log 2>&1 || true
        echo "=== DEBUG LOG START ==="
        cat debug.log
        echo "=== DEBUG LOG END ==="
        # ì‹¤ì œ ì—ëŸ¬ë§Œ ê°ì§€ (FATAL, ì‹¤íŒ¨, ì „ì†¡ ì‹¤íŒ¨ ë“±)
        if grep -qiE "(FATAL|ì‹¤íŒ¨|ì „ì†¡ ì‹¤íŒ¨|ì¹˜ëª…ì )" debug.log; then exit 1; fi

    - name: Cleanup Test Data
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        LOCUST_TEST_USER_ID: ${{ secrets.LOCUST_TEST_USER_ID }}
        FLASK_ENV: production
        PYTHONPATH: .
      run: |
        echo "ğŸ§¹ ë¶€í•˜í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì‹œì‘..."
        python cleanup_test_data.py --hours 2 || true
        echo "âœ… ë°ì´í„° ì •ë¦¬ ì™„ë£Œ"

