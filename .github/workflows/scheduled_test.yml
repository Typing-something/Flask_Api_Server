name: Scheduled Load Test and Report

on:
  # schedule:
  #   - cron: '0 0 * * *'  # ë§¤ì¼ ìì •(UTC) = í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œì— í•œ ë²ˆë§Œ ì‹¤í–‰ (ì¼ì‹œ ë¹„í™œì„±í™”)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ ê°€ëŠ¥

jobs:
  load-test-and-report:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Fix requirements.txt encoding (UTF-16 -> UTF-8)
      run: |
        python -c "
        with open('requirements.txt', 'rb') as f: raw = f.read()
        if raw[:2] == b'\xff\xfe' or (len(raw) > 1 and raw[1:2] == b'\x00'):
            text = raw.decode('utf-16-le')
            with open('requirements.txt', 'w', encoding='utf-8') as f: f.write(text)
            print('Converted UTF-16 to UTF-8')
        "

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-json-report locust requests

    - name: Run Pytest
      env:
        PYTHONPATH: .
        DATABASE_URL: "sqlite:///:memory:"
        FLASK_ENV: testing
      run: |
        pytest --json-report --json-report-file=result.json

    - name: Cleanup Test User Before Load Test (EC2)
      uses: appleboy/ssh-action@master
      with:
        host: "3.34.97.68"
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/Flask_Api_Server
          source venv/bin/activate
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          export LOCUST_TEST_USER_ID="${{ secrets.LOCUST_TEST_USER_ID }}"
          export FLASK_ENV=production
          export PYTHONPATH=.
          python cleanup_test_data.py --keep 100 || true
          echo "âœ… ë¶€í•˜í…ŒìŠ¤íŠ¸ ìœ ì € ê¸°ë¡ ìµœê·¼ 100ê°œë§Œ ìœ ì§€"

    - name: Run Load Test on EC2 (localhost)
      uses: appleboy/ssh-action@master
      with:
        host: "3.34.97.68"
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/Flask_Api_Server
          source venv/bin/activate
          
          # Locust ì‹¤í–‰ (localhostë¡œ ìš”ì²­)
          echo "ğŸš€ EC2 ë‚´ë¶€ì—ì„œ Locust ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹œì‘ (localhost:5000)"
          echo "ğŸ“‹ í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ“‹ Locust íŒŒì¼ í™•ì¸: $(ls -la tests/load/locustfile.py 2>&1 || echo 'íŒŒì¼ ì—†ìŒ')"
          echo "ğŸ“‹ Locust ë²„ì „: $(locust --version 2>&1 || echo 'Locust ë¯¸ì„¤ì¹˜')"
          
          # Locust ì‹¤í–‰ (ì—ëŸ¬ë„ ì¶œë ¥)
          locust -f tests/load/locustfile.py \
            --headless \
            -u 50 \
            -r 10 \
            --run-time 30s \
            --csv /tmp/perf \
            --host http://localhost:5000 2>&1 | tee /tmp/locust_output.log || {
            echo "âŒ Locust ì‹¤í–‰ ì‹¤íŒ¨"
            cat /tmp/locust_output.log || true
            LOCUST_EXIT_CODE=$?
            echo "Exit code: $LOCUST_EXIT_CODE"
          }
          
          # ê²°ê³¼ íŒŒì¼ í™•ì¸
          echo "ğŸ“ ìƒì„±ëœ íŒŒì¼ í™•ì¸:"
          ls -la /tmp/perf* 2>&1 || echo "íŒŒì¼ ì—†ìŒ"
          
          # ê²°ê³¼ íŒŒì¼ì„ íŠ¹ì • ìœ„ì¹˜ì— ì €ì¥
          if [ -f /tmp/perf_stats.csv ]; then
            mv /tmp/perf_stats.csv /tmp/locust_results.csv
            echo "âœ… Locust ê²°ê³¼ íŒŒì¼ ìƒì„± ì™„ë£Œ: /tmp/locust_results.csv"
            echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(wc -l < /tmp/locust_results.csv) lines"
          else
            echo "âš ï¸ Locust ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ğŸ” Locust ì¶œë ¥ ë¡œê·¸:"
            cat /tmp/locust_output.log 2>&1 || echo "ë¡œê·¸ íŒŒì¼ ì—†ìŒ"
            # ë¹ˆ íŒŒì¼ ìƒì„± (scp ì—ëŸ¬ ë°©ì§€)
            touch /tmp/locust_results.csv
            echo "Type,Name,Request Count,Failure Count" > /tmp/locust_results.csv
            echo ",Aggregated,0,0" >> /tmp/locust_results.csv
            echo "âš ï¸ ë¹ˆ ê²°ê³¼ íŒŒì¼ ìƒì„± (ë¶€í•˜í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨)"
          fi

    - name: Download Locust Results from EC2
      uses: appleboy/ssh-action@master
      with:
        host: "3.34.97.68"
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # íŒŒì¼ ì¡´ì¬ ë° ê¶Œí•œ í™•ì¸
          RESULT_FILE="/home/ubuntu/locust_results.csv"
          if [ -f /tmp/locust_results.csv ]; then
            echo "âœ… íŒŒì¼ ì¡´ì¬ í™•ì¸: /tmp/locust_results.csv"
            ls -lh /tmp/locust_results.csv
            # íŒŒì¼ ë‚´ìš© í™•ì¸ (ì²˜ìŒ ëª‡ ì¤„)
            head -5 /tmp/locust_results.csv
            # íŒŒì¼ì„ í™ˆ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬ (ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©)
            cp /tmp/locust_results.csv "$RESULT_FILE"
            chmod 644 "$RESULT_FILE"
            echo "âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: $RESULT_FILE"
            ls -lh "$RESULT_FILE"
          else
            echo "âš ï¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¹ˆ íŒŒì¼ ìƒì„± ì¤‘..."
            echo "Type,Name,Request Count,Failure Count" > "$RESULT_FILE"
            echo ",Aggregated,0,0" >> "$RESULT_FILE"
            chmod 644 "$RESULT_FILE"
            echo "âœ… ë¹ˆ íŒŒì¼ ìƒì„± ì™„ë£Œ: $RESULT_FILE"
          fi

    - name: Download File via SSH
      id: download_file
      uses: appleboy/ssh-action@master
      with:
        host: "3.34.97.68"
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          if [ -f /home/ubuntu/locust_results.csv ]; then
            cat /home/ubuntu/locust_results.csv
          else
            echo "Type,Name,Request Count,Failure Count"
            echo ",Aggregated,0,0"
          fi
        capture_stdout: true
    - name: Save Performance Stats
      run: |
        echo "${{ steps.download_file.outputs.stdout }}" > perf_stats.csv
        echo "âœ… íŒŒì¼ ì €ì¥ ì™„ë£Œ: perf_stats.csv"
        echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(wc -l < perf_stats.csv) lines"
        head -3 perf_stats.csv || true

    - name: Send Combined Report
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        INTERNAL_SYNC_KEY: ${{ secrets.INTERNAL_SYNC_KEY }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SERVER_URL: ${{ secrets.SERVER_URL }}
        LOCUST_TEST_USER_ID: ${{ secrets.LOCUST_TEST_USER_ID }}
        FLASK_ENV: production
        PYTHONPATH: .
      run: |
        python -c "from save_report import send_combined_report; send_combined_report()" > debug.log 2>&1 || true
        echo "=== DEBUG LOG START ==="
        cat debug.log
        echo "=== DEBUG LOG END ==="
        # ì‹¤ì œ ì—ëŸ¬ë§Œ ê°ì§€ (FATAL, ì‹¤íŒ¨, ì „ì†¡ ì‹¤íŒ¨ ë“±)
        if grep -qiE "(FATAL|ì‹¤íŒ¨|ì „ì†¡ ì‹¤íŒ¨|ì¹˜ëª…ì )" debug.log; then exit 1; fi

    - name: Cleanup Test Data on EC2
      uses: appleboy/ssh-action@master
      with:
        host: "3.34.97.68"
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/Flask_Api_Server
          source venv/bin/activate
          echo "ğŸ§¹ ë¶€í•˜í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬ ì‹œì‘..."
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          export LOCUST_TEST_USER_ID="${{ secrets.LOCUST_TEST_USER_ID }}"
          export FLASK_ENV=production
          export PYTHONPATH=.
          python cleanup_test_data.py --hours 2 || true
          echo "âœ… ë°ì´í„° ì •ë¦¬ ì™„ë£Œ"

