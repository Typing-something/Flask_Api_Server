name: CI Test, Report and Deploy

on:
  push:
    branches: [ "main" ] 

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-json-report locust requests

    # Step 1: 가상환경에서 먼저 단위 테스트 실행 ㅋ
    - name: Pre-deployment Check (Pytest)
      run: |
        pytest --json-report --json-report-file=result.json

    # Step 2: 테스트 성공 시에만 EC2 접속 및 배포 ㅋ
    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@master
      with:
        host: "3.34.97.68"
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd /home/ubuntu/study_flask
          git pull origin main
          source .venv/bin/activate
          pip install -r requirements.txt
          flask db upgrade
          sudo systemctl restart flask_app

    # Step 3: 배포된 실서버를 대상으로 부하 테스트 및 통합 리포트 전송 ㅋ
    - name: Post-deployment Load Test & Report
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
        AWS_REGION: ${{ secrets.AWS_REGION }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
        INTERNAL_SYNC_KEY: ${{ secrets.INTERNAL_SYNC_KEY }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        SERVER_URL: ${{ secrets.SERVER_URL }}
        TARGET_HOST: ${{ secrets.TARGET_HOST }}
        FLASK_ENV: production
        PORT: 5000
      run: |
        # Step 1에서 생성된 result.json을 사용하여 리포트를 합칩니다 ㅋ
        python run_all_tests.py